{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Analyzer (Bull vs Bear)</title>

    <style>
    /* === GENERAL PAGE STYLING === */
    body {
        font-family: 'Poppins', sans-serif;
        background-color: #000;
        color: #f5f6fa;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        overflow-x: hidden;
    }

    #candlestick-bg {
        position: fixed;
        top: 0;
        left: 0;
        z-index: -1;
        width: 100vw;
        height: 100vh;
        background-color: #000;
    }

    /* === HEADER STYLING === */
    @keyframes neonPulse {
        0% { text-shadow: 0 0 10px #00ffcc, 0 0 20px #00ffcc; }
        50% { text-shadow: 0 0 15px #00ccff, 0 0 30px #00ffcc; }
        100% { text-shadow: 0 0 10px #00ffcc, 0 0 25px #00ccff; }
    }

    header {
        position: fixed;
        top: 0;
        width: 100%;
        background: rgba(0, 0, 0, 0.85);
        color: #00ffcc;
        text-shadow: 0 0 10px #00ffcc;
        box-shadow: 0 0 20px rgba(0, 255, 204, 0.2);
        border-bottom: 1px solid rgba(0, 255, 204, 0.3);
        z-index: 1000;
        animation: neonPulse 4s ease-in-out infinite alternate;
        transition: transform 0.4s ease, opacity 0.3s ease;
        will-change: transform, opacity;
    }

    .nav-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        max-width: 1100px;
        margin: auto;
        padding: 12px 20px;
    }

    h2 {
        margin: 0;
        font-size: 22px;
        letter-spacing: 1px;
    }

    .nav-buttons {
        display: flex;
        gap: 10px;
    }

    .nav-btn {
        background: linear-gradient(90deg, #00ffcc, #00ccff);
        color: #000;
        font-weight: 600;
        border: none;
        border-radius: 8px;
        padding: 8px 14px;
        cursor: pointer;
        box-shadow: 0 0 10px rgba(0,255,204,0.4);
        transition: all 0.3s ease;
    }

    .nav-btn:hover {
        box-shadow: 0 0 18px #00ffcc;
        transform: translateY(-2px);
    }

    .nav-btn.active {
        background: linear-gradient(90deg, #ff007f, #ff3366);
        color: #fff;
    }

    /* === FOOTER === */
    footer {
        position: fixed;
        bottom: 0;
        width: 100%;
        background: rgba(0, 0, 0, 0.85);
        color: #00ffcc;
        text-align: center;
        border-top: 1px solid rgba(0, 255, 204, 0.3);
        text-shadow: 0 0 10px #00ffcc;
        padding: 10px 0;
        box-shadow: 0 0 20px rgba(0, 255, 204, 0.2);
        z-index: 1000;
        transition: transform 0.4s ease, opacity 0.3s ease;
        will-change: transform, opacity;
    }

    footer p {
        margin: 0;
        font-size: 14px;
        animation: neonPulse 4s ease-in-out infinite alternate;
    }

    /* === MAIN CONTENT === */
    main {
        width: 100%;
        max-width: 1000px;
        padding: 120px 20px 100px;
        box-sizing: border-box;
    }

    .container {
        background: rgba(0, 0, 0, 0.4);
        padding: 24px;
        border-radius: 14px;
        border: 1px solid rgba(0, 255, 204, 0.3);
        box-shadow: 0 0 20px rgba(0, 255, 204, 0.15);
        margin-bottom: 20px;
        transition: all 0.3s ease;
    }
    .container:hover {
        box-shadow: 0 0 30px rgba(0, 255, 204, 0.4);
    }

    h1, h3 {
        color: #00ffcc;
        text-align: center;
        text-shadow: 0 0 12px #00ffcc;
        letter-spacing: 1px;
    }

    h3 {
        color: #ff66cc;
        text-shadow: 0 0 8px #ff66cc;
    }

    input, button {
        padding: 10px;
        border-radius: 8px;
        border: none;
        margin: 5px;
    }

    input {
        border: 1px solid rgba(0,255,204,0.3);
        font-size: 14px;
        background: rgba(10,10,10,0.9);
        color: #fff;
        outline: none;
        transition: 0.2s ease;
    }

    input:focus {
        border-color: #00ffcc;
        box-shadow: 0 0 10px #00ffcc;
    }

    button {
        background: linear-gradient(90deg, #00ffcc, #00ccff);
        color: #000;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    button:hover {
        box-shadow: 0 0 15px #00ffcc;
        transform: translateY(-1px);
    }

    button[name="analyze"] {
        background: linear-gradient(90deg, #ff007f, #ff3366);
    }

    img {
        margin-top: 15px;
        border-radius: 10px;
        max-width: 100%;
        box-shadow: 0 0 25px rgba(0,255,204,0.2);
    }

    table {
        width: 90%;
        margin: 25px auto;
        border-collapse: collapse;
        border: 1px solid rgba(0,255,204,0.3);
    }

    th, td {
        padding: 10px;
        border: 1px solid #00ffcc;
        text-align: center;
    }

    th {
        background-color: rgba(0, 255, 204, 0.15);
    }

    .error {
        background: rgba(255, 0, 80, 0.25);
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #ff3366;
        color: #ffcccc;
        margin-top: 10px;
        text-shadow: 0 0 8px #ff3366;
    }

    .file-upload {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        margin-top: 10px;
        flex-wrap: wrap;
    }
    </style>
</head>

<body>
<header id="page-header">
    <div class="nav-container">
        <h2>üíπ Portfolio Analyzer Dashboard</h2>
        <nav class="nav-buttons">
            <form action="{% url 'home' %}" method="get">
                <button type="submit" class="nav-btn active">Sharpe Ratio Analyzer</button>
            </form>
            <form action="{% url 'efficient_frontier' %}" method="get">
                <button type="submit" class="nav-btn">Efficient Frontier</button>
            </form>
        </nav>
    </div>
</header>

<main>
    <canvas id="candlestick-bg"></canvas>

    <div class="container">
        <h1>Portfolio Input</h1>
        <form id='portfolio-form' method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {{ formset.management_form }}

            <h3>Upload a CSV or Excel File</h3>
            <input type="file" name="file" accept=".csv,.xls,.xlsx">
            <button type="submit" name="action" value='upload_file'>üìÇ Upload File</button>

            <hr style="margin:20px 0; border-color:rgba(0,255,204,0.3);">

            <h3>Manual Entry</h3>
            <div id="form-container">
                {% for form in formset %}
                    <div class="asset-row">
                        {{ form.symbol }} {{ form.weight }}
                        {% for field in form %}
                            {% if field.errors %}
                            <div class="error">
                                {% for err in field.errors %}
                                <p>{{ err }}</p>
                                {% endfor %}
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>

            <button type="button" id="add-row">‚ûï Add another asset</button>
            <button type="submit" name="action" value='analyze'>Analyze</button>
        </form>

        {% if message %}
            <div class="message">{{ message }}</div>
        {% endif %}
        {% if error %}
            <div class="error">{{ error }}</div>
        {% endif %}
    </div>

    {% if portfolio_return %}
        <div>
            <h3>Portfolio Analysis Results</h3>
            <ul>
                <li>Portfolio Return: {{ portfolio_return }}%</li>
                <li>Portfolio Volatility: {{ portfolio_volatility }}%</li>
                <li>Sharpe Ratio: {{ sharpe }}</li>
                <li>Max Daily Loss: {{ max_daily_loss }}%</li>
            </ul>
        </div>
    {% endif %}

    {% if details %}
        <div>
            <h4>Stock Details:</h4>
            <table>
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Weight</th>
                        <th>Mean Return (%)</th>
                        <th>Volatility (%)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for detail in details %}
                        <tr>
                            <td>{{ detail.symbol }}</td>
                            <td>{{ detail.weight }}</td>
                            <td>{{ detail.mean }}</td>
                            <td>{{ detail.vol }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% endif %}

    {% if histogram %}
        <div>
            <h4>Portfolio Daily Returns Distribution</h4>
            <img src="data:image/png;base64,{{ histogram }}" alt="Portfolio Histogram" />
        </div>
    {% endif %}

    {% if portfolio_return %}
        <div style="margin-top: 20px;">
            <form action="{% url 'efficient_frontier' %}" method="POST">
                {% csrf_token %}
                <input type="hidden" name="symbols" value="{{ symbols }}">
                <input type="hidden" name="weights" value="{{ weights }}">
                <button type="submit" style="padding:10px 20px; background:#00ffcc; color:#000; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">
                    Optimizer üöÄ
                </button>
            </form>
        </div>
    {% endif %}
</main>

<footer id="page-footer">
    <p>¬© 2025 StockVision | Tracking Bulls, Bears & Beyond</p>
</footer>

<!-- === SCROLL BEHAVIOR === -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    const header = document.getElementById("page-header");
    const footer = document.getElementById("page-footer");
    let lastScrollY = window.scrollY;

    window.addEventListener("scroll", () => {
        const currentScrollY = window.scrollY;

        if (currentScrollY > lastScrollY && currentScrollY > 100) {
            header.style.transform = "translateY(-100%)";
            header.style.opacity = "0";
        } else if (currentScrollY < lastScrollY) {
            header.style.transform = "translateY(0)";
            header.style.opacity = "1";
        }

        if (currentScrollY + window.innerHeight >= document.documentElement.scrollHeight - 10) {
            footer.style.transform = "translateY(0)";
            footer.style.opacity = "1";
        } else if (currentScrollY < lastScrollY) {
            footer.style.transform = "translateY(0)";
            footer.style.opacity = "1";
        } else {
            footer.style.transform = "translateY(100%)";
            footer.style.opacity = "0";
        }

        lastScrollY = currentScrollY;
    });
});
</script>

<!-- === ADD ROW JS === -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const formContainer = document.getElementById("form-container");
    const addRowBtn = document.getElementById("add-row");
    if (!formContainer || !addRowBtn) return;

    let totalForms = parseInt(document.querySelector('input[name="form-TOTAL_FORMS"]').value);
    addRowBtn.addEventListener("click", function () {
        const firstRow = formContainer.querySelector(".asset-row");
        const newRow = firstRow.cloneNode(true);
        newRow.querySelectorAll("input").forEach((input) => {
            const name = input.name.replace(/form-(\d+)-/, `form-${totalForms}-`);
            const id = input.id.replace(/form-(\d+)-/, `form-${totalForms}-`);
            input.name = name;
            input.id = id;
            input.value = "";
        });
        formContainer.appendChild(newRow);
        totalForms += 1;
        document.querySelector('input[name="form-TOTAL_FORMS"]').value = totalForms;
    });
});
</script>

<!-- === SNOWFALL BACKGROUND === -->
<canvas id="snowfall-bg" style="position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1;"></canvas>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const canvas = document.getElementById("snowfall-bg");
    const ctx = canvas.getContext("2d");

    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    // üî∏ Get Sharpe ratio dynamically from Django context
    const sharpeRatio = parseFloat("{{ max_sharpe_ratio|default:0 }}");

    // ‚ùÑÔ∏è Default white color and glow
    let snowColor = "rgba(255,255,255,0.9)";
    let glowColor = "#FFFFFF";

    // üî¥ If Sharpe < 1 ‚Üí red glow; üü¢ If Sharpe ‚â• 1 ‚Üí green glow
    if (!isNaN(sharpeRatio)) {
        if (sharpeRatio >= 1) {
            snowColor = "rgba(0,255,153,0.85)";
            glowColor = "#00FF99";
        } else if (sharpeRatio < 1) {
            snowColor = "rgba(255,51,102,0.85)";
            glowColor = "#FF3366";
        }
    }

    // üßä Snowflake setup
    const snowflakes = [];
    const numFlakes = 120; // small number for subtle snowfall

    for (let i = 0; i < numFlakes; i++) {
        snowflakes.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height,
            r: Math.random() * 2 + 0.5, // small radius
            d: Math.random() * 1 + 0.5, // density/speed
        });
    }

    function drawSnow() {
        // Slight fade for trailing glow effect
        ctx.fillStyle = "rgba(0, 0, 0, 1)";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.fillStyle = snowColor;
        ctx.shadowBlur = 10;
        ctx.shadowColor = glowColor;

        snowflakes.forEach(flake => {
            ctx.beginPath();
            ctx.arc(flake.x, flake.y, flake.r, 0, Math.PI * 2);
            ctx.fill();
        });

        moveSnow();
        requestAnimationFrame(drawSnow);
    }

    let angle = 0;
    function moveSnow() {
        angle += 0.01;
        snowflakes.forEach(flake => {
            flake.y += Math.pow(flake.d, 2) + 0.5;
            flake.x += Math.sin(angle) * 0.5;

            if (flake.y > canvas.height) {
                flake.y = -5;
                flake.x = Math.random() * canvas.width;
            }
        });
    }

    drawSnow();
});
</script>
</body>
</html>
